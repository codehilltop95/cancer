import pandas as pd
import streamlit as st
from snowflake.snowpark.context import get_active_session
import plotly.express as px
import base64
import requests
st.set_page_config(page_title="Oncology KPI Dashboard", layout="wide")
st.title("ONCOLOGY OVERVIEW ⚕️")
st.caption(f"""A real time analytical dashboard showing key oncological transformations showing
key oncology performance metrics including the provider details along with encounter trends and patient distribution""")
session = get_active_session()

def set_sidebar(url):
    theme_base ="light"
    overlay_rgba = (
    f"rgba(255,255,255,0.80)"
    )
    safe_url = url.replace('"', '%22')
    st.markdown(
        f"""
<style>
[data-testid="stSidebar"] {{
    background: url("{safe_url}") no-repeat center center;
    background-size: cover;
}}
[data-testid="stSidebar"] > div:first-child {{
    background-color: {overlay_rgba};
}}
</style>
""",
        unsafe_allow_html=True,
    )
def main_background(
    url: str,
    theme_base: str = "light",
    overlay_opacity: float = 0.65,
    blur_px: int = 0
):
    if theme_base.lower() == "dark":
        overlay_rgba = f"rgba(0,0,0,{overlay_opacity})"
    else:
        overlay_rgba = f"rgba(255,255,255,{overlay_opacity})"

    safe_url = url.replace('"', '%22')

    st.markdown(
        f"""
<style>
.stApp {{
    background: linear-gradient({overlay_rgba}, {overlay_rgba}), url("{safe_url}") no-repeat center center fixed !important;
    background-size: cover !important;
    {'backdrop-filter: blur(' + str(blur_px) + 'px);' if blur_px > 0 else ''}
}}

[data-testid="stAppViewContainer"] {{
    background: linear-gradient({overlay_rgba}, {overlay_rgba}), url("{safe_url}") no-repeat center center fixed !important;
    background-size: cover !important;
    {'backdrop-filter: blur(' + str(blur_px) + 'px);' if blur_px > 0 else ''}
}}

.block-container {{
    background-color: rgba(255,255,255,0.00) !important;
}}
</style>
""",
        unsafe_allow_html=True,
    )   

def bar_chart(df, cancer_name: str, selected_values_label: str):
    st.subheader(f"TOTAL {selected_values_label} cases for {cancer_name}")

    if df.empty:
        st.info("No data available for the selected filters.")
        return

    chart_df = df.rename(columns={"ENCOUNTER_STATUS": "Status", "TOTAL": "Total"})
    chart_df["Status"] = chart_df["Status"].astype(str)

    status_palette = {
        "SCHEDULED": "#3182CE",
        "IN_PROGRESS": "#DD6B20",
        "COMPLETED": "#38A169",
        "CANCELLED": "#E53E3E",
        "NO_SHOW": "#805AD5",
        "ON_HOLD": "#D69E2E",
        "OTHER": "#718096"
    }

    fig = px.bar(
        chart_df.sort_values("Total", ascending=False),
        y="Status",
        x="Total",
        orientation="h",
        color="Status",
        color_discrete_map=status_palette,
        text="Total",
        hover_data={"Total": ":,", "Status": True},
        title=f"Encounter Status Distribution — {cancer_name}<br><sup>Filter: {selected_values_label}</sup>"
    )

    fig.update_traces(
        texttemplate="%{text:,}",
        textposition="outside",
        cliponaxis=False,
        marker_line_color="rgba(0,0,0,0.1)",
        marker_line_width=1
    )

    fig.update_layout(
        height=360,
        xaxis_title="Number of encounters",
        yaxis_title="Encounter status",
        xaxis=dict(showgrid=True, gridcolor="rgba(0,0,0,0.08)", zeroline=False),
        yaxis=dict(showgrid=False),
        margin=dict(l=10, r=10, t=60, b=10),
        legend=dict(orientation="h", y=-0.2, x=0),
        bargap=0.25,
        template="plotly_white"
    )

    st.plotly_chart(fig, use_container_width=True)
with st.sidebar:
#CORTEX AI SERACH
    st.markdown("### ")
    show_ai = st.checkbox("Enable AI Search Panel")
    user_query=None
    if show_ai:
        st.markdown("### ❤❤ YOUR PERSONAL HEALTH AI")
        user_query = st.text_input("HERE TO HELP")
        query=None
        if user_query:
            st.info("Cortex AI: Processing...")
            query =f"""
	SELECT snowflake.cortex.complete(
    	'mistral-large',
    	'You are an Oncology Data Assistant.

    	STRICT RULES:
    	- Use only the data found in ONCOLOGY_ENCOUNTERS, PATIENT, PROVIDER, CANCER_CATALOG
    	- NEVER say you cannot access the tables (you CAN)
    	- NEVER output SQL queries
    	- NEVER explain how you got the answer
    	- ONLY output the final answer to the user concisely

    	User question: {user_query}
    	'
	) AS ANSWER"""
        if query:
            response = session.sql(query).to_pandas()["ANSWER"][0]
    st.header("FILTER")
    z = session.sql("""
        SELECT SERVICE_DATE
        FROM CURATED.ONCOLOGY_ENCOUNTERS;
    """).to_pandas()
    status=session.sql("""
    
    select DISTINCT ENCOUNTER_STATUS
    
    FROM ONCOLOGY_ENCOUNTERS
    
    """).to_pandas()["ENCOUNTER_STATUS"].tolist()
    selected_status=st.multiselect(
        "Status",options=status
    )
    if selected_status:
        selected_values=",".join([f"'{s}'" for s in selected_status])
        where_clause=f"WHERE ENCOUNTER_STATUS IN ({selected_values})"
    else:
        selected_values="ALL"
        where_clause=f"WHERE ENCOUNTER_STATUS IS NOT NULL"
    if not z.empty:
        z["SERVICE_DATE"] = pd.to_datetime(z["SERVICE_DATE"], format='mixed', dayfirst=True).dt.date
        min_date = z["SERVICE_DATE"].min()
        max_date= z["SERVICE_DATE"].max()
        with st.expander("DATE RANGE", expanded=False):
            m = st.slider(
                "FILTER_DATE",
                min_value=min_date,
                max_value=max_date,
                format="YYYY-MM-DD",
            )
DATE_TABLE=session.table("ONCOLOGY_ENCOUNTERS").to_pandas()
DATE_TABLE["SERVICE_DATE"]=pd.to_datetime(DATE_TABLE["SERVICE_DATE"],format='mixed',dayfirst=True).dt.date
DATE_TABLE = DATE_TABLE[(DATE_TABLE["SERVICE_DATE"] >= min_date) & (DATE_TABLE["SERVICE_DATE"] <= m)]
DATE_TABLE=(
	DATE_TABLE.groupby("SERVICE_DATE")["ENCOUNTER_ID"].count()
	.reset_index()
	.sort_values("SERVICE_DATE")
)
fig = px.line(
	DATE_TABLE,
	x="SERVICE_DATE",
	y="ENCOUNTER_ID",
	markers=True,
	title=f"{min_date} to {m}"
)
s1,s2=st.columns(2)
#TOTAL NO OF PATIENTS
TOTAL_NO_OF_PATIENTS=session.sql(f"""
select count(*) AS TOTAL from ONCOLOGY_ENCOUNTERS
{where_clause}
""").collect()[0]["TOTAL"]
with s1:
    s1.metric(F"TOTAL PATIENTS FOR {selected_values}",TOTAL_NO_OF_PATIENTS)
    GROSS_BILLED = session.sql(f"""
    SELECT SUM(BILLED_AMOUNT) AS AMT
    FROM ONCOLOGY_ENCOUNTERS
    {where_clause}
    """).collect()[0]["AMT"]
    
    s2.metric(f"TOTAL BILLED AMOUNT {selected_values}", round(GROSS_BILLED,2))
st.subheader("A DAILY TREND OF HOW MANY ENCOUNTERS ARE HAPPENING IN OUT IN THE WORLD")
st.plotly_chart(fig, use_container_width=True)
#NAME OF PATIENTS SUFFERING FROM A PARTICULAR CANCER

TOTAL_NO_OF_PATIENTS=session.sql(f""" select DISTINCT CANCER_NAME FROM CANCER_CATALOG
""").to_pandas()["CANCER_NAME"].tolist()
box=st.selectbox("CANCER NAME",TOTAL_NO_OF_PATIENTS)
where_clause="" if box==None else f"WHERE C.CANCER_NAME='{box}'"
n=session.sql(f"""
select CONCAT(P.FIRST_NAME,' ',P.LAST_NAME) AS NAME,
P.GENDER AS GENDER,P.DOB AS DATE_OF_BIRTH,P.CITY AS CITY,P.STATE AS STATE,P.COUNTRY AS COUNTRY,
P.PAYER_ID AS PAYER_ID,P.UPDATED_AT AS UPDATED_AT,C.CANCER_NAME AS CANCER_NAME
FROM PATIENT P INNER JOIN ONCOLOGY_ENCOUNTERS E ON 
P.PATIENT_ID=E.PATIENT_ID INNER JOIN CANCER_CATALOG C ON C.CANCER_CODE=E.CANCER_CODE
{where_clause}
""").to_pandas()
st.dataframe(n)

#Bar Chart
if selected_values=="ALL":
    where_clause_2="E.ENCOUNTER_STATUS IS NOT NULL"
else:
    where_clause_2=f"E.ENCOUNTER_STATUS IN ({selected_values})"
BAR_CHART=session.sql(f"""select count(*) as TOTAL,
E.ENCOUNTER_STATUS AS ENCOUNTER_STATUS FROM ONCOLOGY_ENCOUNTERS E
INNER JOIN CANCER_CATALOG C ON C.CANCER_CODE=E.CANCER_CODE
{where_clause} and {where_clause_2}
GROUP BY ENCOUNTER_STATUS
""").to_pandas()
main_background(
    "https://images.pexels.com/photos/4966406/pexels-photo-4966406.jpeg",
    theme_base="light",
    overlay_opacity=0.80,
    blur_px=0
)
s3,s4=st.columns(2)
#PIE CHART
PIE_CHART=session.sql(f"""
select count(*) as TOTAL,P.PROVIDER_NAME AS PROVIDER_NAME
FROM PROVIDER P INNER JOIN ONCOLOGY_ENCOUNTERS E ON
P.PROVIDER_ID=E.PROVIDER_ID INNER JOIN CANCER_CATALOG C
ON C.CANCER_CODE=E.CANCER_CODE
{where_clause}
GROUP BY PROVIDER_NAME
""").to_pandas()
with s3:
    bar_chart(BAR_CHART, cancer_name=box, selected_values_label=selected_values)
with s4:
    fig = px.pie(
    PIE_CHART,
    names="PROVIDER_NAME",
    values="TOTAL",
    title=f"BEST HOSPITAL FOR {box} TREATMENT",
    hole=0.35)
    st.plotly_chart(fig,use_container_width=True)
#EARLY STAGE VS LAST STAGE FOR A PARTICULAR CANCER

#AI ANSWER RESPONSE
if user_query:
    st.subheader(f"""SEARCH RESULTS FOR '{user_query}'""")
    st.markdown(f"####{response}")
else:
    st.subheader(f"""YOUR AI RESPONSE WILL BE VISIBLE HERE """)
set_sidebar("https://images.pexels.com/photos/6629369/pexels-photo-6629369.jpeg")